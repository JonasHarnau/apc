import unittest
import pandas as pd
import numpy as np
from apc.Model import Model
from apc.data.pre_formatted import loss_TA

class TestFit(unittest.TestCase):

    def test_TA_odp(self):
        model = Model()
        model.data_from_df(loss_TA(), time_adjust=1)
        model.fit(family='od_poisson_response', predictor='AC')
        model.fit_table()
        dev_table_Ad = model.fit_table(reference_predictor='Ad', 
                                        attach_to_self=False)
        
        self.assertEqual(round(model.deviance,3), 1903014.004)
        self.assertTrue(np.allclose(
            model.deviance_table.values,
            np.array([
                 [1.90301400e+06, 3.60000000e+01, 0.00000000e+00, np.nan, 
                  np.nan, np.nan, np.nan],
                 [2.26975638e+06, 4.40000000e+01, np.nan, 3.66742376e+05, 
                 8.00000000e+00, 8.67224670e-01, 5.52460650e-01],
                 [7.80786706e+06, 4.40000000e+01, np.nan, 5.90485306e+06, 
                 8.00000000e+00, 1.39630285e+01, 5.57824176e-09],
                [2.47405267e+06, 4.50000000e+01, np.nan, 5.71038670e+05, 
                 9.00000000e+00, 1.20028264e+00, 3.24889856e-01],
                [8.59757852e+06, 4.50000000e+01, np.nan, 6.69456452e+06, 
                 9.00000000e+00, 1.40714982e+01, 2.28532582e-09],
                [8.89772511e+06, 5.20000000e+01, np.nan, 6.99471110e+06, 
                 1.60000000e+01, 8.27009152e+00, 8.67290327e-08],
                [9.09618109e+06, 5.30000000e+01, np.nan, 7.19316708e+06, 
                 1.70000000e+01, 8.00445456e+00, 9.89397304e-08],
                [9.67492468e+06, 5.30000000e+01, np.nan, 7.77191068e+06, 
                 1.70000000e+01, 8.64847224e+00, 3.63679865e-08],
                [1.06994644e+07, 5.40000000e+01, np.nan, 8.79645043e+06, 
                 1.80000000e+01, 9.24475638e+00, 1.13640819e-08]
            ]), 
            equal_nan=True)
                       )
        self.assertTrue(np.allclose(
            dev_table_Ad.values,
            np.array([
                [2.26975638e+06, 4.40000000e+01, 0.00000000e+00, np.nan, 
                 np.nan, np.nan, np.nan],
                [2.47405267e+06, 4.50000000e+01, np.nan, 2.04296293e+05, 
                 1.00000000e+00, 3.96035318e+00, 5.28199266e-02],
                [8.89772511e+06, 5.20000000e+01, np.nan, 6.62796873e+06, 
                 8.00000000e+00, 1.60606787e+01, 8.80953088e-11],
                [9.09618109e+06, 5.30000000e+01, np.nan, 6.82642471e+06, 
                 9.00000000e+00, 1.47036185e+01, 1.26508914e-10],
                [1.06994644e+07, 5.40000000e+01, np.nan, 8.42970805e+06, 
                 1.00000000e+01, 1.63412760e+01, 9.25903798e-12]
            ]), 
            equal_nan=True)
                       )
        
        
    def test_Belgian_ln_rates(self):
        data = pd.read_excel('./apc/data/Belgian_lung_cancer.xlsx', 
                             sheetname = ['response', 'rates'], 
                             index_col = 0)
        model = Model()
        model.data_from_df(data['response'], rate=data['rates'], 
                           data_format='AP')
        model.fit(family='log_normal_rates', predictor='APC')
        model.fit_table()
        
        self.assertTrue(np.allclose(
            model.deviance_table.values,
            np.array([
                [ -4.48541926e+01,   1.80000000e+01,  np.nan, 
                       np.nan, np.nan,   7.14580741e+00],
                [ -2.89978040e+01,   3.00000000e+01,   1.58563886e+01,
                   1.20000000e+01,   1.97902635e-01,  -9.97804023e-01],
                [ -4.34535281e+01,   2.00000000e+01,   1.40066447e+00,
                   2.00000000e+00,   4.96420349e-01,   4.54647188e+00],
                [  1.26313918e+01,   2.70000000e+01,   5.74855844e+01,
                   9.00000000e+00,   4.07916712e-09,   4.66313918e+01],
                [ -2.80421983e+01,   3.20000000e+01,   1.68119943e+01,
                   1.40000000e+01,   2.66335267e-01,  -4.04219834e+00],
                [  4.76056314e+01,   3.90000000e+01,   9.24598239e+01,
                   2.10000000e+01,   6.05452355e-11,   5.76056314e+01],
                [  1.27105303e+01,   2.90000000e+01,   5.75647229e+01,
                   1.10000000e+01,   2.61820415e-08,   4.27105303e+01],
                [ -1.49167453e+01,   3.30000000e+01,   2.99374473e+01,
                   1.50000000e+01,   1.21490641e-02,   7.08325470e+00],
                [  1.65610725e+02,   4.00000000e+01,   2.10464918e+02,
                   2.20000000e+01,   0.00000000e+00,   1.73610725e+02],
                [  8.82613661e+01,   3.00000000e+01,   1.33115559e+02,
                   1.20000000e+01,   0.00000000e+00,   1.16261366e+02],
                [  4.77747017e+01,   4.10000000e+01,   9.26288943e+01,
                   2.30000000e+01,   2.56291099e-10,   5.37747017e+01],
                [  5.04233530e+01,   4.20000000e+01,   9.52775456e+01,
                   2.40000000e+01,   1.89606886e-10,   5.44233530e+01],
                [  1.65622315e+02,   4.20000000e+01,   2.10476508e+02,
                   2.40000000e+01,   0.00000000e+00,   1.69622315e+02],
                [  9.80993338e+01,   4.20000000e+01,   1.42953526e+02,
                   2.40000000e+01,   0.00000000e+00,   1.02099334e+02],
                [  1.65809402e+02,   4.30000000e+01,   2.10663595e+02,
                   2.50000000e+01,   0.00000000e+00,   1.67809402e+02]]
                    ), 
            equal_nan=True)
                       )
        

if __name__ == '__main__':
    unittest.main()
    
    
    
    
    